<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>HLS Player</title>
</head>

<body>
    <video playsinline autoplay muted preload="true" id="video" height="auto" controls></video>
    <div id="metadata"></div>
    <script src="hls-parser"></script>
    <script src="hls"></script>

    <script>

        const videoElement = document.getElementById('video');
        const metadataContainer = document.getElementById('metadata')


        /** Player used to embed live stream on a webpage */
        class AirPlayer {

            constructor(options) {

                this.options = options;
                this.videoElement = options.videoElement;
                this.videoSource = options.videoSource;
                if (Hls.isSupported()) {
                    this.setupWithHlsLib();
                } else {
                    this.setupWithoutHlsLib();
                }
                // this.setupWithoutHlsLib();

                var switchAwayTime;
                var switchBackTime;

                this.totalJumpedAbout = 0;

                document.addEventListener("visibilitychange", () => {
                    if (document.hidden) {
                        switchAwayTime = Date.now();
                        console.log('currentTime away', this.videoElement.currentTime)

                        console.log("Browser tab is hidden")
                    } else {
                        switchBackTime = Date.now();
                        const timeToJump = switchBackTime - switchAwayTime;
                        console.log('timeToJump', timeToJump);
                        console.log("Browser tab is visible")
                        console.log('currentTime back', this.videoElement.currentTime)
                        if (this.videoElement.muted) {
                            console.log('jump')
                            this.videoElement.currentTime = this.videoElement.currentTime + timeToJump;
                            this.totalJumpedAbout = this.totalJumpedAbout + timeToJump;
                        } else {
                            console.log('no jump')
                        }

                    }
                });



            }

            setupWithHlsLib() {
                const hls = new Hls({
                    renderTextTracksNatively: false,
                    xhrSetup: function (xhr, url) {
                        xhr.setRequestHeader('Access-Control-Allow-Headers', '*')
                    }
                });

                hls.loadSource(this.videoSource);
                hls.attachMedia(this.videoElement);

                hls.on(Hls.Events.FRAG_CHANGED, (data, frag) => {
                    const tag = this.getMetadataTagFromTagList(frag.frag.tagList);
                    if (!tag) {
                        return;
                    }
                    const metadata = this.getMetadataFromTag(tag);
                    this.options.onMetadataUpdate(metadata);

                });
                hls.on(Hls.Events.FRAG_LOADED, (data, data2) => {
                    // console.log('hls3', data, data2);
                });
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    this.videoElement.play();
                });
            }

            setupWithoutHlsLib() {
                this.videoElement.src = this.videoSource;
                this.videoElement.addEventListener('loadedmetadata', async(event) => {
                    var startingVidTime;
                    this.videoElement.play();
                    setInterval(async()=>{
                        const m3u8Response = await fetch(this.videoSource)
                        const m3u8FileContent = await m3u8Response.text();

                        var parser = new m3u8Parser.Parser();

                        parser.push(m3u8FileContent);
                        // debugger

                        console.log(Math.round(this.videoElement.currentTime*1000))
                        const currentVidTime = Math.round(this.videoElement.currentTime*1000);
                        if(!startingVidTime){
                            console.log('set starting vid')
                            startingVidTime = Date.parse(parser.manifest.segments[0].dateTimeString)

                        }
                        console.log(startingVidTime)
                        const currentVidSegmentDate = currentVidTime+startingVidTime+ this.totalJumpedAbout
                        console.log('date of currently playing segment', new Date(currentVidSegmentDate))


                        console.log(parser)
                        // get closest date
                    
                    },3000)

                });


                // cancel when nav away?
                setInterval(async () => {
                    //refactor into fetch function
                    const m3u8Response = await fetch(this.videoSource)
                    const m3u8FileContent = await m3u8Response.text();
                    var parser = new m3u8Parser.Parser();

                    parser.push(m3u8FileContent);
                    const manifest = parser.manifest;
                    if (manifest.dateRanges.length < 1) {
                        return
                    }
                    if (parser.manifest.mediaSequence > 1) {
                        const metadata = manifest.dateRanges[manifest.dateRanges.length - 3]
                        this.options.onMetadataUpdate(metadata.xCustomKey);

                    } else {
                        const metadata = manifest.dateRanges[manifest.dateRanges.length - 1]
                        this.options.onMetadataUpdate(metadata.xCustomKey);


                    }

                }, 2000);
            }

            getMetadataTagFromTagList(tagList) {
                const metadataTag = tagList.filter((tag) => {
                    if (tag[0] === "EXT-X-DATERANGE") {
                        return tag;
                    }
                });
                if (metadataTag.length > 0) {
                    return metadataTag[0];
                }
            }

            getMetadataFromTag(tag) {
                return tag[1].split(",")[5].split("=")[1].split('"')[1];
            }


            decodeJson(payload) {
                const decodedPayload = JSON.parse(decodeURIComponent(payload));
                return decodedPayload;
            }

            // equivilant online tools for non devs https://www.freeformatter.com/json-escape.html or https://jsontostring.com/
            encodeJson(payload) {
                const encodedPayload = encodeURIComponent(JSON.stringify(payload));
                console.log(encodedPayload);
                return encodedPayload;
            }


        }


        const player = new AirPlayer({
            videoElement: videoElement,
            videoSource: '/events/1/output.m3u8',
            onMetadataUpdate: (data) => {
                const decodedJson = player.decodeJson(data)
                metadataContainer.innerHTML = decodedJson.description;
            }
        });
        console.log('- - - -', player);


        var data = {
title: 'The San Sebastian Interview',
description: `San Sebastian is a name that's quickly gaining prominence in the Parisian fashion scene. As a gifted stylist and art director, Sebastian has mastered the art of merging the raw energy of streetwear with the timeless elegance of premium fashion. After carving out a niche for himself in the world of premium streetwear, his diverse portfolio now includes acclaimed music videos, personal clients, and catwalk showcases. Sebastian's journey started in the Caribbean, a fact that, while not always overt, subtly influences his work. However, it's his life in Paris that's truly honed his stylistic instincts. For SneakTV's interview, he candidly discussed his fashion journey, detailing the myriad of influences that shape his unique style. His love for sneakers mirrors his eclectic tastes, Sebastian considers these to be more than just an accessory. For him, they are an integral part of the cultural dialogue between streetwear and high fashion. His recent works continue to reflect this, often featuring imaginative reinterpretations of classic sneaker designs. In essence, Sebastian represents the new wave of fashion creatives, those who are not just participants but push the boundaries of traditional style norms. His Caribbean roots and Parisian influences converge to create a unique fashion narrative, positioning him firmly at the forefront of the Paris fashion scene.`,
productIds: ['gid://shopify/Product/8147416416515', 'gid://shopify/Product/8103980990723', 'gid://shopify/Product/8103980990723', 'gid://shopify/Product/8103980990723'],
}

var data = {
title: 'Title: Salomon x Gramicci - Techsonic Launch',
description: `At the end of April, Sneak In Peace celebrated the hotly-anticipated release of the Salomon x Gramicci TECHSONIC at Outsiders Store’s launch party in London. The ultimate sneaker for hardcore watersports (or just typical British weather, really), this sandal-like shoe boasts a breathable mesh upper that’s engineered to dry out ASAP, and a collapsible, water resistant construction that will keep your feet nice and dry at all times. Salomon has also added a Quicklace lacing system and an extra rugged Vibe midsole that will make any gorpcore enthusiast envious, and co-branded detailing decks out the tongue and insole, finishing off the adventure-ready silhouette.`,
productIds: ['gid://shopify/Product/8049361191171', 'gid://shopify/Product/8153060835587', 'gid://shopify/Product/8153059787011', 'gid://shopify/Product/8153057755395'],
}

var data = {
title: 'Title: Visvim, Fukuoka, Store Visit',
description: `To some heads, Japanese menswear brand Visvim require no introduction. Founded by Hiroki Nakamura in Ura-Harajuku in 2001, the cult brand is known for contemporary spins on classic and unique vintage pieces. Their no-stone-unturned approach sees them dive into every detail of design, materials and manufacture in pursuit of unimaginably subtle, luxurious and authentic product.`,
productIds: ['gid://shopify/Product/8139750244611', 'gid://shopify/Product/8053239513347', 'gid://shopify/Product/7990656106755', 'gid://shopify/Product/8054763487491'],
}

    </script>
</body>

</html>